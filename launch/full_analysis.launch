<launch>

    <!--
    This launch file runs the complete analysis and visualization setup.
    It plays the necessary rosbags and launches all processing nodes.
    It opens two RViz instances for world-centric and body-centric views.
    -->

    <!-- Set use_sim_time for the entire ROS system -->
    <param name="use_sim_time" value="true"/>

    <!-- Arguments for the bag file paths -->
    <arg name="sensor_bag"      default="/mnt/d/Ubuntu20ROS1/Euroc_ws/MH_04_difficult.bag" />
    <arg name="groundtruth_bag" default="/mnt/d/Ubuntu20ROS1/Euroc_ws/MH_04_difficult_true.bag" />

    <!-- Static transform from body to imu0 frame -->
    <!-- For MH_04, this is identity, but we publish it for correctness and generality -->
    <node pkg="tf" type="static_transform_publisher" name="body_to_imu0_broadcaster"
          args="0 0 0 0 0 0 ground_truth_body imu0 100" />

    <!-- Load parameters from the config file -->
    <rosparam file="$(find imu_algorithm_visualization)/config/default.yaml" command="load" />
    <rosparam file="$(find imu_algorithm_visualization)/config/transforms.yaml" command="load" />

    <!-- Play the rosbags -->
    <node pkg="rosbag" type="play" name="sensor_player" output="screen" required="true" args="--clock $(arg sensor_bag)"/>
    <node pkg="rosbag" type="play" name="groundtruth_player" output="screen" required="true"
          args="$(arg groundtruth_bag)"/>

    <!--
    ======================================
    === OUR VISUALIZATION & ANALYSIS NODES ===
    ======================================
    -->

    <!-- 1. Ground Truth Node (publishes velocity, accel, etc.) -->
    <node pkg="imu_algorithm_visualization" type="ground_truth_visualizer_node" name="ground_truth_visualizer_node" output="screen"/>

    <!-- 2. Gravity Measurement Node (with auto-calibration) -->
    <node pkg="imu_algorithm_visualization" type="gravity_measurement_visualizer_node" name="gravity_measurement_visualizer_node" output="screen">
        <param name="auto_calibrate_duration" value="2.0"/> <!-- Auto-calibrate for the first 2.0 seconds -->
        <remap from="/imu0" to="/mav0/imu0"/>
        <remap from="/ground_truth/pose" to="/mav0/state_groundtruth_estimate0/pose"/>
    </node>

    <!-- 3. IMU Corrector Node (for bias/drift removal, if any) -->
    <node pkg="ahrs_algorithms" type="imu_corrector_node" name="imu_corrector_node" output="screen">
        <remap from="/imu0" to="/mav0/imu0"/>
        <remap from="/imu/corrected" to="/imu/corrected"/> <!-- Output topic -->
    </node>

    <!-- 4. Quaternion Integrator Node (AHRS algorithm) -->
    <node pkg="ahrs_algorithms" type="quaternion_integrator_node" name="quaternion_integrator_node" output="screen">
        <remap from="/imu/corrected" to="/imu/corrected"/>
        <remap from="/ground_truth/pose" to="/mav0/state_groundtruth_estimate0/pose"/>
    </node>

    <!-- 5. IMU Total Error Visualizer Node -->
    <node pkg="imu_algorithm_visualization" type="imu_error_visualizer_node" name="imu_error_visualizer_node" output="screen">
        <remap from="/imu0" to="/mav0/imu0"/>
        <remap from="/ground_truth/pose" to="/mav0/state_groundtruth_estimate0/pose"/>
    </node>

    <!-- 6. Attitude Error Visualizer Node -->
    <node pkg="imu_algorithm_visualization" type="attitude_error_visualizer_node" name="attitude_error_visualizer_node" output="screen">
        <remap from="/imu0" to="/mav0/imu0"/>
        <remap from="/ground_truth/pose" to="/mav0/state_groundtruth_estimate0/pose"/>
    </node>


    <!--
    ========================
    === RVIZ INSTANCES ===
    ========================
    -->

    <!-- RViz 1: World-centric view -->
    <node type="rviz" name="World_Observer" pkg="rviz" args="-d $(find imu_algorithm_visualization)/rviz/imu_visualization.rviz" />

    <!-- RViz 2: Body-centric attitude analysis view -->
    <node type="rviz" name="Attitude_Analysis" pkg="rviz" args="-d $(find imu_algorithm_visualization)/rviz/attitude_error_view.rviz" />

</launch>
